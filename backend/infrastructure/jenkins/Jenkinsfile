def deployApp(Map config) {
    def composeFile = config.composeFile ?: 'docker-compose.yml'

    def sshCredId = config.sshKeyCredentialId ?: env.SSH_KEY_CRED
    def vmHostCredId = config.vmHostCredentialId ?: env.VM_HOST_CRED
    def dbUserCredId = config.dbUserCredentialId ?: env.DB_USER_CRED
    def dbPassCredId = config.dbPasswordCredentialId ?: env.DB_PASS_CRED
    def dbCredId = config.dbCredentialId ?: null
    def dockerCredId = config.dockerCredentialId ?: env.DOCKERHUB_CREDENTIALS

    // Safeguard: ensure required credential IDs are present; fail early with a readable message
    def missing = []
    if (!sshCredId) { missing << 'sshKeyCredentialId (SSH key)'}
    if (!vmHostCredId) { missing << 'vmHostCredentialId (VM host)'}
    if (!(dbCredId || (dbUserCredId && dbPassCredId))) { missing << 'dbCredentialId or both dbUserCredentialId & dbPasswordCredentialId (DB credentials)'}

    if (missing) {
        echo "Missing required Jenkins credential IDs: ${missing.join(', ')}"
        error("Missing required Jenkins credential IDs: ${missing.join(', ')}")
    }

    // Logging: print which credential IDs will be used (credential IDs are not secret values)
    def dbBindingMethod = dbCredId ? "single(${dbCredId})" : "separate(user:${dbUserCredId},pass:${dbPassCredId})"
    echo "Using credential IDs -> SSH_KEY: ${sshCredId}, VM_HOST: ${vmHostCredId}, DB: ${dbBindingMethod}, DOCKER_HUB: ${dockerCredId ?: 'none'}"

    def creds = [
        sshUserPrivateKey(credentialsId: sshCredId, keyFileVariable: 'SSH_KEY'),
        string(credentialsId: vmHostCredId, variable: 'VM_HOST')
    ]

    if (dbCredId) {
        creds << usernamePassword(credentialsId: dbCredId, usernameVariable: 'POSTGRES_USER', passwordVariable: 'POSTGRES_PASSWORD')
    } else {
        if (dbUserCredId) {
            creds << string(credentialsId: dbUserCredId, variable: 'POSTGRES_USER')
        }
        if (dbPassCredId) {
            creds << string(credentialsId: dbPassCredId, variable: 'POSTGRES_PASSWORD')
        }
    }

    if (dockerCredId) {
        creds << usernamePassword(credentialsId: dockerCredId, usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_PASS')
    }

    withCredentials(creds) {
         def deployImage = (env.BRANCH_NAME == 'main') ? "edydockers/backend-horsetrust" : "edydockers/backend-horsetrust"
         def imageTag = config.imageTag
         def fullBackendImage = "${deployImage}:${imageTag}"

         def pgHost = (env.POSTGRES_HOST ?: config.postgresHost) ?: 'database'
         def pgPort = (env.POSTGRES_PORT ?: config.postgresPort) ?: '5432'
         def pgDb   = (env.POSTGRES_DB   ?: config.postgresDb)   ?: 'horse-trust'
         def pgUrl  = (env.POSTGRES_DOCKER_URL ?: config.postgresUrl) ?: null
         def pgUser = (env.POSTGRES_USER ?: config.postgresUser) ?: ''
         def pgPass = (env.POSTGRES_PASSWORD ?: config.postgresPassword) ?: ''

         def allEnvVars = """
            BACKEND_IMAGE='${fullBackendImage}'
            COMPOSE_PROJECT_NAME='horsetrust-backend'
            POSTGRES_HOST='${pgHost}'
            POSTGRES_PORT='${pgPort}'
            POSTGRES_DB='${pgDb}'
            POSTGRES_USER='${pgUser}'
            POSTGRES_PASSWORD='${pgPass}'
         """

         if (pgUrl) {
            allEnvVars += " POSTGRES_DOCKER_URL='${pgUrl}'"
         }

         if (dockerCredId) {
            allEnvVars += " DOCKERHUB_USER='${DOCKERHUB_USER}' DOCKERHUB_PASS='${DOCKERHUB_PASS}'"
         }

         allEnvVars = allEnvVars.stripIndent().trim().replaceAll('\n', ' ')

         echo "üöÄ Deploying image: ${fullBackendImage} to ${VM_HOST}"

         sh "scp -i ${SSH_KEY} -o StrictHostKeyChecking=no infrastructure/docker/${composeFile} ${VM_USER}@${VM_HOST}:${VM_PROJECT_PATH}/docker-compose.yml"

         sh """
             ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${VM_USER}@${VM_HOST} "
                 set -e
                 cd ${VM_PROJECT_PATH}

                 echo '--- Ensuring horse-net exists ---'
                 sudo docker network create horse-net 2>/dev/null || true

                 echo '--- Checking for legacy containers to remove ---'
                 for c in sports-management-backend postgres-db-prod redis-cache; do
                     if sudo docker ps -a --format '{{.Names}}' | grep -q '^'\$c'\$'; then
                         PROJ=\$(sudo docker inspect --format '{{index ..Config.Labels "com.docker.compose.project"}}' \\${c} 2>/dev/null || echo '')
                         if [ '\$PROJ' != 'sports-backend' ]; then
                             echo 'Found container from different project: '\$c'. Removing...'
                             sudo docker stop \$c 2>/dev/null || true
                             sudo docker rm \$c 2>/dev/null || true
                         fi
                     fi
                 done

                 echo '--- Docker Hub login (if credentials present) ---'
                 if [ -n "\$DOCKERHUB_USER" ]; then
                     echo 'Logging into Docker Hub...'
                     echo "\$DOCKERHUB_PASS" | sudo env ${allEnvVars} docker login -u "\$DOCKERHUB_USER" --password-stdin || true
                 fi

                 echo '--- Pulling new images ---'
                 sudo env ${allEnvVars} docker compose pull

                 echo '--- Restarting services with Docker Compose V2 ---'
                 sudo env ${allEnvVars} docker compose up -d --force-recreate

                 echo '--- Cleanup and verification ---'
                 sudo docker image prune -f
                 sudo docker ps
             "
         """
     }
}

pipeline {
    agent { label "worker-node-02" }

    tools {
        jdk 'jdk21'
        maven 'maven3'
    }

    triggers { githubPush() }

    environment {
        VM_USER                    = 'jenkins'
        VM_PROJECT_PATH            = '/home/jenkins/horsetrust'
        DOCKER_USERNAME            = 'edydockers'
        IMAGE_NAME                 = "local/horsetrust"
        DOCKERHUB_CREDENTIALS      = 'edydockers-credentials'
        SSH_KEY_CRED               = 'vm-ssh-key-98'
        VM_HOST_CRED               = 'vm-ip-98'
        DB_USER_CRED               = 'horsetrust-db-name'
        DB_PASS_CRED               = 'horsetrust-db-pass'
     }

    stages {
        stage('Checkout Source Code') {
            when { branch 'main' }
            steps {
                cleanWs(deleteDirs: true)
                checkout scm
            }
        }

        stage('Build Application') {
            when { branch 'main' }
            steps {
                sh "mvn clean install -DskipTests"
            }
        }

        stage('Build Docker Image') {
            when { branch 'main' }
            steps {
                script {
                    sh "docker build -t ${IMAGE_NAME} -f infrastructure/docker/Dockerfile ."
                }
            }
        }

        stage('Push Docker Image') {
            when { branch 'main' }
            steps {
                script {
                    def imageToPush = "edydockers/backend-horsetrust"
                    def imageTag = "prod-${env.BUILD_NUMBER}"
                    def latestTag = "latest"

                    withCredentials([usernamePassword(credentialsId: env.DOCKERHUB_CREDENTIALS, usernameVariable: 'DUSER', passwordVariable: 'DPASS')]) {
                        sh """#!/bin/bash
                            set -euo pipefail

                            echo "Logging in to Docker Hub..."
                            echo '${DPASS}' | docker login -u '${DUSER}' --password-stdin

                            echo "Pushing Build Tag: ${imageToPush}:${imageTag}"
                            docker tag ${IMAGE_NAME} ${imageToPush}:${imageTag}
                            docker push ${imageToPush}:${imageTag}

                            echo "Pushing Latest Tag: ${imageToPush}:${latestTag}"
                            docker tag ${IMAGE_NAME} ${imageToPush}:${latestTag}
                            docker push ${imageToPush}:${latestTag}

                            docker logout
                        """
                    }
                }
            }
        }

        stage('Deploy to Production') {
            when { branch 'main' }
            steps {
                script {
                    deployApp(
                        vmHostCredentialId: 'vm-ip-98',
                        imageTag: "prod-${env.BUILD_NUMBER}",
                        sshKeyCredentialId: 'vm-ssh-key-98',
                        dbUserCredentialId: 'horsetrust-db-name',
                        dbPasswordCredentialId: 'horsetrust-db-pass',
                        springProfile: 'prod',
                        frontendBaseUrl: 'https://horsetrust.codershub.top'
                    )
                 }
             }
         }
    }

    post {
        always {
            script {
                if (env.BRANCH_NAME == 'main') {
                    sh "docker rmi ${IMAGE_NAME} || true"
                }
            }
            cleanWs()
        }
        // success {
        //     script {
        //         if (env.BRANCH_NAME == 'main') {
        //             slackSend (channel: SLACK_CHANNEL, color: 'good', message: "‚úÖ SUCCESS: '${JOB_NAME}' on branch '${BRANCH_NAME}' finished successfully.")
        //         }
        //     }
        // }
        // failure {
        //     script {
        //         if (env.BRANCH_NAME == 'main') {
        //             slackSend (channel: SLACK_CHANNEL, color: 'danger', message: "‚ùå FAILURE: '${JOB_NAME}' on branch '${BRANCH_NAME}' failed.")
        //         }
        //     }
        // }
    }
}
