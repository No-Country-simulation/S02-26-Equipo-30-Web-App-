def deployApp(Map config) {
    def composeFile = config.composeFile ?: 'docker-compose.yml'

    // 1. Map Credential IDs for VM and DockerHub
    def creds = [
        sshUserPrivateKey(credentialsId: config.sshKeyCredentialId, keyFileVariable: 'SSH_KEY'),
        string(credentialsId: config.vmHostCredentialId, variable: 'VM_HOST'),
        string(credentialsId: config.dbUserCredentialId, variable: 'RAW_DB_NAME'),
        string(credentialsId: config.dbPasswordCredentialId, variable: 'POSTGRES_PASSWORD'),
        string(credentialsId: config.dbUrlCredentialId, variable: 'POSTGRES_DOCKER_URL'),
        string(credentialsId: config.secretKeyCredentialId, variable: 'SECRET_KEY'),
        usernamePassword(credentialsId: config.dockerCredentialId, usernameVariable: 'DUSER', passwordVariable: 'DPASS')
    ]

    withCredentials(creds) {
         def imageTag = config.imageTag
         def fullBackendImage = "edydockers/backend-horsetrust:${imageTag}"

         // HARDCODED DB NAME: Solves the credential value vs name mismatch permanently
         def dbToUse = "HorseTrustDb1"

         def clean = { v ->
            if (v == null) return ''
            def s = v.replaceAll('\r', '').trim()
            if ((s.startsWith("'") && s.endsWith("'")) || (s.startsWith('"') && s.endsWith('"'))) {
                s = s.substring(1, s.length()-1)
            }
            return s
         }

         // 2. Build .env with Proxy and Swagger visibility fixes
         def envLines = []
         envLines << "BACKEND_IMAGE=${fullBackendImage}"
         envLines << "POSTGRES_DB=${dbToUse}"
         envLines << "POSTGRES_PASSWORD=${clean(POSTGRES_PASSWORD)}"
         envLines << "SPRING_DATASOURCE_URL=jdbc:postgresql://database:5432/${dbToUse}"
         envLines << "SECRET_KEY=${clean(SECRET_KEY)}"
         envLines << "SPRINGDOC_SWAGGER_UI_ENABLED=true"
         envLines << "SPRINGDOC_API_DOCS_ENABLED=true"
         envLines << "SERVER_FORWARD_HEADERS_STRATEGY=framework"
         envLines << "SPRINGDOC_CONFIG_PATH=/v3/api-docs"
         envLines << "SPRINGDOC_SWAGGER-UI_CONFIG-URL=/v3/api-docs/swagger-config"
         envLines << "SPRINGDOC_SWAGGER_UI_URL=/v3/api-docs"

         writeFile file: 'remote.env', text: envLines.join('\n')

         // 3. Sync to VM
         sh "ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no jenkins@${VM_HOST} 'mkdir -p /home/jenkins/horsetrust'"
         sh "scp -i ${SSH_KEY} -o StrictHostKeyChecking=no backend/horse-retail/infrastructure/docker/${composeFile} jenkins@${VM_HOST}:/home/jenkins/horsetrust/docker-compose.yml"
         sh "scp -i ${SSH_KEY} -o StrictHostKeyChecking=no remote.env jenkins@${VM_HOST}:/home/jenkins/horsetrust/.env"

         // 4. Remote Execution: Kill Host Postgres, Wipe Docker, Force DB Creation
         sh """
            ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no jenkins@${VM_HOST} '
                cd /home/jenkins/horsetrust &&
                sudo fuser -k 5432/tcp || true
                sudo systemctl stop postgresql 2>/dev/null || true
                sudo docker network create horse-net 2>/dev/null || true
                sudo docker compose down -v --remove-orphans
                echo "${DPASS}" | sudo docker login -u "${DUSER}" --password-stdin
                sudo docker compose up -d database
                sleep 15
                sudo docker exec horsetrust-backend-database-1 psql -U postgres -c "CREATE DATABASE \\"${dbToUse}\\";" || true
                sudo docker compose up -d spring
                sleep 8
                sudo docker restart horsetrust-backend-spring-1
                sudo docker logout'
         """
         sh 'rm -f remote.env'
     }
}

pipeline {
    agent { label "worker-node-02" }
    tools { jdk 'jdk21'; maven 'maven3' }

    environment {
        VM_PROJECT_PATH = '/home/jenkins/horsetrust'
        IMAGE_NAME      = "local/horsetrust"
        DOCKERHUB_CRED  = 'edydockers-credentials'
        APP_DIR         = 'backend/horse-retail'
        DOCKER_DIR      = 'backend/horse-retail/infrastructure/docker'
    }

    stages {
        stage('Checkout Source Code') {
            steps {
                cleanWs(deleteDirs: true)
                // In SCM mode, this automatically uses the URL/Credentials from the job settings
                checkout scm
            }
        }

        stage('Build Application') {
            steps {
                sh "mvn -f ${APP_DIR}/pom.xml clean install -DskipTests"
            }
        }

        stage('Build and Push Image') {
            steps {
                script {
                    def tag = "prod-${env.BUILD_NUMBER}"
                    sh "docker build -t ${IMAGE_NAME} -f ${DOCKER_DIR}/Dockerfile ${APP_DIR}"
                    withCredentials([usernamePassword(credentialsId: env.DOCKERHUB_CRED, usernameVariable: 'U', passwordVariable: 'P')]) {
                        sh "echo \"\$P\" | docker login -u \"\$U\" --password-stdin"
                        sh "docker tag ${IMAGE_NAME} edydockers/backend-horsetrust:${tag}"
                        sh "docker tag ${IMAGE_NAME} edydockers/backend-horsetrust:latest"
                        sh "docker push edydockers/backend-horsetrust:${tag}"
                        sh "docker push edydockers/backend-horsetrust:latest"
                    }
                }
            }
        }

        stage('Deploy to Production') {
            steps {
                script {
                    deployApp(
                        vmHostCredentialId: 'vm-ip-98',
                        imageTag: "prod-${env.BUILD_NUMBER}",
                        sshKeyCredentialId: 'vm-ssh-key-98',
                        dbUserCredentialId: 'horsetrust-db-name',
                        dbPasswordCredentialId: 'horsetrust-db-pass',
                        dbUrlCredentialId: 'horsetrust-db-url',
                        secretKeyCredentialId: 'horsetrust-secret-key',
                        dockerCredentialId: env.DOCKERHUB_CRED
                    )
                 }
             }
         }
    }

    post {
        always {
            sh "docker rmi ${IMAGE_NAME} || true"
            cleanWs()
        }
    }
}